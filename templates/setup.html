<!DOCTYPE html>
<html class="dark" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Setup - FlareGate Dashboard</title>
<link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
<link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ec4899",
                        "background-light": "#fdf4f9",
                        "background-dark": "#111827",
                        "surface-dark": "#1f2937",
                    },
                    fontFamily: {
                        "display": ["Spline Sans", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "1rem", "lg": "2rem", "xl": "3rem", "full": "9999px" },
                },
            },
        }
    </script>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-gray-900 dark:text-gray-100 antialiased min-h-screen flex flex-col relative">

<main class="flex-grow flex items-center justify-center p-4">
    <div class="w-full max-w-xl bg-surface-dark bg-gradient-to-br from-gray-900 to-black border border-primary/20 rounded-md relative overflow-hidden shadow-2xl flex flex-col">
        <div class="absolute top-0 right-0 w-64 h-64 bg-primary/10 rounded-lg blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
        <div class="absolute bottom-0 left-0 w-64 h-64 bg-primary/10 rounded-lg blur-3xl translate-y-1/2 -translate-x-1/2 pointer-events-none"></div>
        
        <div class="p-8 relative z-10 text-center">
            <h1 class="text-3xl font-bold text-white mb-2">Setup Tunnel</h1>
            <p class="text-gray-400 text-sm mb-8">Enter your Cloudflare API credentials to get started.</p>

            <div id="step-1">
                <div class="flex flex-col gap-4 text-left">
                    <div>
                        <label class="block text-xs font-bold text-primary mb-1 uppercase tracking-wider ml-1">Cloudflare API Token</label>
                        <input id="api-token" class="w-full bg-black/40 border border-white/10 rounded-md px-4 py-3 text-white placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary transition-all" placeholder="Enter your API token" type="password"/>
                    </div>
                    <button id="verify-btn" class="w-full bg-primary hover:bg-pink-600 text-white font-bold py-3 rounded-md transition-all shadow-lg shadow-primary/20 flex items-center justify-center gap-2">
                        <span>Verify Token</span>
                        <span class="material-symbols-outlined">arrow_forward</span>
                    </button>
                    <div id="setup-error" class="hidden text-red-500 text-sm text-center bg-red-500/10 p-2 rounded-lg border border-red-500/20"></div>
                </div>
            </div>

            <div id="step-2" class="hidden text-left flex flex-col gap-4">
                <div class="bg-primary/10 border border-primary/20 p-4 rounded-md text-center mb-4">
                    <span class="material-symbols-outlined text-primary text-3xl mb-1">check_circle</span>
                    <p class="text-white font-semibold">Token Verified</p>
                    <p class="text-xs text-gray-400">Account ID: <span id="account-id-display" class="font-mono text-primary"></span></p>
                </div>

                <div>
                   <label class="block text-xs font-bold text-primary mb-1 uppercase tracking-wider ml-1">Select Tunnel</label>
                   <select id="tunnel-select" class="w-full bg-black/40 border border-white/10 rounded-md px-4 py-3 text-white focus:border-primary focus:ring-1 focus:ring-primary transition-all">
                       <option value="" disabled selected>Choose a tunnel...</option>
                   </select>
                </div>

                <div class="flex gap-3 mt-4">
                    <button onclick="location.reload()" class="w-1/3 bg-white/5 hover:bg-white/10 text-gray-300 font-bold py-3 rounded-md transition-all">Back</button>
                    <button id="save-config-btn" class="w-2/3 bg-primary hover:bg-pink-600 text-white font-bold py-3 rounded-md transition-all shadow-lg shadow-primary/20">
                        Save & Continue
                    </button>
                </div>
            </div>
            
            <div id="setup-loading" class="hidden absolute inset-0 bg-black/80 backdrop-blur-sm z-50 flex flex-col items-center justify-center rounded-md">
                 <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-lg animate-spin mb-4"></div>
                 <p class="text-white font-medium">Processing...</p>
            </div>
        </div>
    </div>
</main>
<script>
    // Setup Wizard JS
    const apiBase = '/api';
    const verifyBtn = document.getElementById('verify-btn');
    const apiTokenInput = document.getElementById('api-token');
    const setupError = document.getElementById('setup-error');
    const step1 = document.getElementById('step-1');
    const step2 = document.getElementById('step-2');
    const loading = document.getElementById('setup-loading');
    const tunnelSelect = document.getElementById('tunnel-select');
    const accountIdDisplay = document.getElementById('account-id-display');
    const saveConfigBtn = document.getElementById('save-config-btn');

    let currentToken = '';
    let currentAccountId = '';

    verifyBtn.addEventListener('click', async () => {
        const token = apiTokenInput.value.trim();
        if(!token) return;
        
        setupError.classList.add('hidden');
        loading.classList.remove('hidden');

        try {
            const res = await fetch(`${apiBase}/verify-token`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({token})
            });
            const data = await res.json();

            if(data.success) {
                currentToken = token;
                currentAccountId = data.account_id;
                accountIdDisplay.textContent = currentAccountId;

                // Populate tunnels
                tunnelSelect.innerHTML = '<option value="" disabled selected>Choose a tunnel...</option>';
                data.tunnels.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.id;
                    opt.textContent = t.name;
                    tunnelSelect.appendChild(opt);
                });

                step1.classList.add('hidden');
                step2.classList.remove('hidden');
            } else {
                setupError.textContent = data.error || 'Verification failed';
                setupError.classList.remove('hidden');
            }
        } catch(e) {
            setupError.textContent = 'Network error';
            setupError.classList.remove('hidden');
        } finally {
            loading.classList.add('hidden');
        }
    });

    saveConfigBtn.addEventListener('click', async () => {
        const tunnelId = tunnelSelect.value;
        if(!tunnelId) return;

        const tunnelName = tunnelSelect.options[tunnelSelect.selectedIndex].text;
        loading.classList.remove('hidden');

        try {
            const res = await fetch(`${apiBase}/save-config`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    api_token: currentToken,
                    account_id: currentAccountId,
                    tunnel_id: tunnelId,
                    tunnel_name: tunnelName
                })
            });
            const data = await res.json();
            if(data.success) {
                // Redirect to root after success
                window.location.href = "/";
            } else {
                setupError.textContent = data.error || 'Save failed';
                setupError.classList.remove('hidden');
                step2.classList.add('hidden');
                step1.classList.remove('hidden');
            }
        } catch(e) {
            alert('Error saving config');
        } finally {
            loading.classList.add('hidden');
        }
    });
</script>
</body>
</html>
